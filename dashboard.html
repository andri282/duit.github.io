<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Keuangan</title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <div id="loading">Sinkronisasi Data...</div>

    <div class="app-container">
      <div class="header-info">
        <span id="welcome-msg">Halo, User</span>
        <a href="#" onclick="logout()" style="color: var(--danger); text-decoration: none; font-weight: bold">Logout</a>
      </div>

      <div id="view-home" class="view-section active">
        <div class="balance-card">
          <h2>Sisa Saldo</h2>
          <h1 id="balance">Rp 0</h1>
        </div>

        <div class="summary-grid">
          <div class="card text-center">
            <h4>Pemasukan</h4>
            <p id="money-plus" class="money-plus">+Rp 0</p>
          </div>
          <div class="card text-center">
            <h4>Pengeluaran</h4>
            <p id="money-minus" class="money-minus">-Rp 0</p>
          </div>
        </div>

        <div class="input-group" id="input-card">
          <h3 id="form-title">Tambah Transaksi</h3>
          <form id="form">
            <input type="hidden" id="edit-id" />
            <div class="form-row">
              <input type="date" id="date" class="form-control" required />
              <select id="type" class="form-control">
                <option value="expense">Pengeluaran (-)</option>
                <option value="income">Pemasukan (+)</option>
              </select>
            </div>
            <input type="text" id="text" class="form-control" placeholder="Keterangan" required />
            <input list="categories" id="category" class="form-control" placeholder="Kategori" required />
            <datalist id="categories">
              <option value="Gaji"></option>
              <option value="Bonus"></option>
              <option value="Makan"></option>
              <option value="Belanja"></option>
              <option value="Transport"></option>
              <option value="Tagihan"></option>
            </datalist>

            <input type="number" id="amount" class="form-control" placeholder="Jumlah (Rp)" required />
            <button type="submit" id="submit-btn" class="btn">Simpan</button>
            <button type="button" id="cancel-btn" class="btn btn-cancel" onclick="cancelEdit()">Batal Edit</button>
          </form>
        </div>

        <h3>Riwayat Terakhir</h3>
        <ul id="list" class="history-list"></ul>
      </div>

      <div id="view-chart" class="view-section">
        <h3 class="text-center">Filter Statistik</h3>

        <div class="filter-container">
          <div class="filter-row">
            <div>
              <span class="filter-label">Dari Tanggal</span>
              <input type="date" id="filter-start" class="filter-control" onchange="applyFilter()" />
            </div>
            <div>
              <span class="filter-label">Sampai Tanggal</span>
              <input type="date" id="filter-end" class="filter-control" onchange="applyFilter()" />
            </div>
          </div>
          <div class="filter-row">
            <div>
              <span class="filter-label">Jenis</span>
              <select id="filter-type" class="filter-control" onchange="applyFilter()">
                <option value="all">Semua</option>
                <option value="expense">Pengeluaran</option>
                <option value="income">Pemasukan</option>
              </select>
            </div>
            <div>
              <span class="filter-label">Kategori</span>
              <select id="filter-category" class="filter-control" onchange="applyFilter()">
                <option value="all">Semua Kategori</option>
              </select>
            </div>
          </div>
          <button class="btn-reset" onclick="resetFilter()">Reset Filter</button>
        </div>

        <div class="chart-container" style="height: auto; min-height: 400px">
          <h4 class="text-center" id="chart-title">Analisa Pengeluaran</h4>
          <div class="chart-wrapper">
            <canvas id="expenseChart"></canvas>
          </div>

          <div class="summary-grid" style="margin-top: 20px">
            <div class="text-center">
              <small>Total Filter</small>
              <p id="filter-total" style="font-weight: bold; margin: 5px 0">Rp 0</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="bottom-nav">
      <div class="nav-item active" onclick="switchTab('home')" id="nav-home">
        <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" /></svg>
        <span>Transaksi</span>
      </div>
      <div class="nav-item" onclick="switchTab('chart')" id="nav-chart">
        <svg viewBox="0 0 24 24"><path d="M11 2v20c-5.07-.5-9-4.79-9-10s3.93-9.5 9-10zm2 0v11h10.99c-.18-5.7-4.9-10.45-10.99-10.45zm0 13v7c5.63-.55 10.1-5.02 10.65-10.65H13z" /></svg>
        <span>Statistik</span>
      </div>
    </div>

    <script>
      // --- MASUKKAN URL GOOGLE SCRIPT ---
      const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwkEam74ZMFuskgfq9nzEkn3imJfPRQpV38SleairvjbKO_W28iVkJ8tS8G8fdwQ2Ze7Q/exec";
      // ----------------------------------

      const currentUser = localStorage.getItem("currentUser");
      if (!currentUser) window.location.href = "index.html";
      document.getElementById("welcome-msg").innerText = "Halo, " + currentUser;

      let chartInstance = null;
      let allTransactions = []; // Menyimpan semua data mentah
      const form = document.getElementById("form");
      const loading = document.getElementById("loading");
      let isEditing = false;

      // Set Default Date hari ini
      document.getElementById("date").valueAsDate = new Date();

      // Set Filter Default (Awal bulan ini s/d Hari ini)
      const today = new Date();
      const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
      document.getElementById("filter-end").valueAsDate = today;
      document.getElementById("filter-start").valueAsDate = firstDay;

      window.onload = fetchData;

      function logout() {
        localStorage.removeItem("currentUser");
        window.location.href = "index.html";
      }

      function switchTab(tab) {
        document.querySelectorAll(".view-section, .nav-item").forEach((el) => el.classList.remove("active"));
        document.getElementById("view-" + tab).classList.add("active");
        document.getElementById("nav-" + tab).classList.add("active");

        // Jika pindah ke chart, jalankan filter ulang biar chart update
        if (tab === "chart") applyFilter();
      }

      // --- DATA HANDLING ---
      form.addEventListener("submit", function (e) {
        e.preventDefault();
        const type = document.getElementById("type").value;
        const amountVal = document.getElementById("amount").value;

        const data = {
          action: isEditing ? "edit" : "add",
          id: isEditing ? document.getElementById("edit-id").value : new Date().getTime(),
          date: document.getElementById("date").value,
          type: type,
          text: document.getElementById("text").value,
          category: document.getElementById("category").value,
          amount: type === "expense" ? -Math.abs(amountVal) : Math.abs(amountVal),
          user: currentUser,
        };
        sendData(data);
      });

      function sendData(data) {
        loading.style.display = "block";
        fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(data) })
          .then((res) => res.json())
          .then((res) => {
            loading.style.display = "none";
            if (res.result === "success") {
              alert("Berhasil!");
              if (isEditing) cancelEdit();
              else form.reset();
              document.getElementById("date").valueAsDate = new Date();
              fetchData();
            } else {
              alert("Gagal: " + res.message);
            }
          })
          .catch((err) => {
            alert("Koneksi Error");
            loading.style.display = "none";
          });
      }

      function fetchData() {
        loading.style.display = "block";
        fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "get" }) })
          .then((res) => res.json())
          .then((res) => {
            loading.style.display = "none";
            if (res.result === "success") {
              allTransactions = res.data; // Simpan data mentah ke variabel global
              updateDOM(allTransactions); // Update List Transaksi
              populateCategoryFilter(allTransactions); // Isi dropdown kategori
              applyFilter(); // Jalankan filter chart
            }
          });
      }

      // --- FILTER & CHART LOGIC ---
      function populateCategoryFilter(data) {
        const catSelect = document.getElementById("filter-category");
        const currentVal = catSelect.value;
        // Ambil kategori unik
        const categories = [...new Set(data.map((item) => item.category))];

        catSelect.innerHTML = '<option value="all">Semua Kategori</option>';
        categories.sort().forEach((cat) => {
          const option = document.createElement("option");
          option.value = cat;
          option.innerText = cat;
          catSelect.appendChild(option);
        });
        catSelect.value = currentVal; // Balikin pilihan user jika ada
      }

      function applyFilter() {
        const startDate = document.getElementById("filter-start").value;
        const endDate = document.getElementById("filter-end").value;
        const filterType = document.getElementById("filter-type").value;
        const filterCat = document.getElementById("filter-category").value;

        // Lakukan penyaringan data
        const filteredData = allTransactions.filter((t) => {
          const tDate = t.date.split("T")[0]; // Ambil YYYY-MM-DD
          const isDateMatch = tDate >= startDate && tDate <= endDate;

          // Logika Tipe (Expense/Income)
          let isTypeMatch = true;
          if (filterType === "expense") isTypeMatch = t.amount < 0;
          if (filterType === "income") isTypeMatch = t.amount > 0;

          const isCatMatch = filterCat === "all" || t.category === filterCat;

          return isDateMatch && isTypeMatch && isCatMatch;
        });

        updateChart(filteredData);
      }

      function resetFilter() {
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);

        document.getElementById("filter-start").valueAsDate = firstDay;
        document.getElementById("filter-end").valueAsDate = today;
        document.getElementById("filter-type").value = "all";
        document.getElementById("filter-category").value = "all";
        applyFilter();
      }

      function updateChart(transactions) {
        const ctx = document.getElementById("expenseChart").getContext("2d");
        const filterType = document.getElementById("filter-type").value;

        const categoryTotals = {};
        let grandTotal = 0;

        // Tentukan apa yang mau ditampilkan di chart
        // Kalau filter "Income", tampilkan Income. Selain itu tampilkan Expense (default).
        const showIncome = filterType === "income";
        const chartTitle = showIncome ? "Analisa Pemasukan" : "Analisa Pengeluaran";
        document.getElementById("chart-title").innerText = chartTitle;

        transactions.forEach((t) => {
          const amt = Number(t.amount);
          // Jika mode Income, ambil yg positif. Jika mode Expense/All, ambil yg negatif
          if ((showIncome && amt > 0) || (!showIncome && amt < 0)) {
            const cat = t.category;
            const absAmt = Math.abs(amt);
            categoryTotals[cat] = (categoryTotals[cat] || 0) + absAmt;
            grandTotal += absAmt; // Total untuk chart
          }
        });

        // Update Text Total Filter di bawah chart
        // Hitung total bersih dari data yang difilter (Income - Expense)
        const netTotal = transactions.reduce((acc, curr) => acc + Number(curr.amount), 0);
        document.getElementById("filter-total").innerText = formatRupiah(netTotal);
        // Beri warna hijau jika plus, merah jika minus
        document.getElementById("filter-total").style.color = netTotal >= 0 ? "var(--success)" : "var(--danger)";

        const labels = Object.keys(categoryTotals);
        const data = Object.values(categoryTotals);

        if (chartInstance) chartInstance.destroy();

        if (labels.length === 0) {
          // Tampilkan chart kosong atau pesan jika tidak ada data
          return;
        }

        chartInstance = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: labels,
            datasets: [
              {
                data: data,
                backgroundColor: ["#ef4444", "#f59e0b", "#3b82f6", "#10b981", "#8b5cf6", "#ec4899", "#6366f1", "#14b8a6"],
                borderWidth: 2,
                borderColor: "#ffffff",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: "bottom", labels: { boxWidth: 12, font: { size: 11 }, padding: 15 } },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    let value = context.raw;
                    let percentage = ((value / grandTotal) * 100).toFixed(1) + "%";
                    return ` ${context.label}: ${formatRupiah(value)} (${percentage})`;
                  },
                },
              },
            },
          },
        });
      }

      // --- DOM UPDATES ---
      function updateDOM(transactions) {
        const list = document.getElementById("list");
        const balance = document.getElementById("balance");
        const money_plus = document.getElementById("money-plus");
        const money_minus = document.getElementById("money-minus");

        list.innerHTML = "";
        if (!transactions) return;

        const amounts = transactions.map((t) => Number(t.amount));
        const total = amounts.reduce((acc, item) => (acc += item), 0);
        const income = amounts.filter((item) => item > 0).reduce((acc, item) => (acc += item), 0);
        const expense = amounts.filter((item) => item < 0).reduce((acc, item) => (acc += item), 0) * -1;

        balance.innerText = formatRupiah(total);
        money_plus.innerText = `+${formatRupiah(income)}`;
        money_minus.innerText = `-${formatRupiah(expense)}`;

        transactions
          .slice()
          .reverse()
          .forEach((t) => {
            const sign = t.amount < 0 ? "-" : "+";
            const item = document.createElement("li");
            item.classList.add("history-item");
            item.classList.add(t.amount < 0 ? "minus" : "plus");

            const safeText = t.text.replace(/'/g, "\\'");
            const safeCat = t.category.replace(/'/g, "\\'");
            const userBadge = t.user ? `<span class="user-badge">${t.user}</span>` : "";

            item.innerHTML = `
                <div style="flex-grow:1">
                    <div style="display:flex; align-items:center"><strong>${t.text}</strong> ${userBadge}</div>
                    <span style="font-size:12px; color:#666">${t.category} â€¢ ${t.date.split("T")[0]}</span>
                </div>
                <div style="text-align:right">
                    <span>${sign}${formatRupiah(Math.abs(t.amount))}</span>
                    <div style="margin-top:5px">
                        <button class="btn-mini btn-edit" onclick="startEdit('${t.id}', '${t.date}', '${safeText}', '${safeCat}', ${t.amount})">Edit</button>
                        <button class="btn-mini btn-delete" onclick="deleteItem('${t.id}')">Hapus</button>
                    </div>
                </div>`;
            list.appendChild(item);
          });
      }

      function formatRupiah(n) {
        return new Intl.NumberFormat("id-ID", { style: "currency", currency: "IDR", minimumFractionDigits: 0 }).format(n);
      }

      window.startEdit = function (id, date, text, category, amount) {
        switchTab("home");
        isEditing = true;
        document.getElementById("input-card").scrollIntoView({ behavior: "smooth" });
        document.getElementById("input-card").classList.add("editing");
        document.getElementById("form-title").innerText = "Edit Transaksi";
        document.getElementById("submit-btn").innerText = "Update";
        document.getElementById("cancel-btn").style.display = "block";

        document.getElementById("edit-id").value = id;
        document.getElementById("date").value = date.split("T")[0];
        document.getElementById("text").value = text;
        document.getElementById("category").value = category;
        document.getElementById("amount").value = Math.abs(amount);
        document.getElementById("type").value = amount < 0 ? "expense" : "income";
      };

      window.cancelEdit = function () {
        isEditing = false;
        form.reset();
        document.getElementById("date").valueAsDate = new Date();
        document.getElementById("input-card").classList.remove("editing");
        document.getElementById("form-title").innerText = "Tambah Transaksi";
        document.getElementById("submit-btn").innerText = "Simpan";
        document.getElementById("cancel-btn").style.display = "none";
      };

      window.deleteItem = function (id) {
        if (confirm("Hapus data ini?")) sendData({ action: "delete", id: id });
      };
    </script>
  </body>
</html>
