<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DompetKu - Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      :root {
        --primary: #2563eb;
        --success: #16a34a;
        --danger: #dc2626;
        --bg: #f3f4f6;
        --card: #ffffff;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: var(--bg);
        margin: 0;
        padding: 0;
        color: #333;
      }

      /* LOGIN */
      #login-page {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        background: var(--primary);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 100;
      }
      .login-box {
        background: white;
        padding: 30px;
        border-radius: 12px;
        width: 90%;
        max-width: 350px;
        text-align: center;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      }
      .login-box input {
        width: 100%;
        padding: 12px;
        margin: 15px 0;
        border: 2px solid #eee;
        border-radius: 8px;
        font-size: 16px;
        text-align: center;
        box-sizing: border-box;
      }

      /* APP */
      #app-page {
        display: none;
        padding: 20px;
        max-width: 600px;
        margin: 0 auto;
        padding-bottom: 80px;
      }
      #loading {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        z-index: 99;
        text-align: center;
        padding-top: 200px;
        font-weight: bold;
      }

      .header-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        color: #666;
        font-size: 14px;
      }
      .balance-card {
        background: var(--primary);
        color: white;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .balance-card h1 {
        margin: 10px 0;
        font-size: 32px;
      }

      .summary-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 20px;
      }
      .card {
        background: var(--card);
        padding: 15px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }
      .money-plus {
        color: var(--success);
        font-weight: bold;
      }
      .money-minus {
        color: var(--danger);
        font-weight: bold;
      }

      /* CHART CONTAINER */
      .chart-section {
        background: var(--card);
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }
      .chart-wrapper {
        position: relative;
        height: 250px;
        width: 100%;
        display: flex;
        justify-content: center;
      }

      .input-group {
        background: var(--card);
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }
      .input-group.editing {
        border: 2px solid var(--primary);
        background: #eff6ff;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .form-control {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        box-sizing: border-box;
      }

      .btn {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        background: var(--primary);
        color: white;
        font-size: 16px;
      }
      .btn-cancel {
        background: #94a3b8;
        margin-top: 10px;
        display: none;
      }

      .history-list {
        list-style: none;
        padding: 0;
      }
      .history-item {
        background: var(--card);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-left: 5px solid transparent;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }
      .history-item.plus {
        border-left-color: var(--success);
      }
      .history-item.minus {
        border-left-color: var(--danger);
      }

      .item-actions {
        display: flex;
        gap: 5px;
        margin-left: 10px;
        margin-top: 5px;
        justify-content: flex-end;
      }
      .btn-mini {
        padding: 4px 8px;
        font-size: 11px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        color: white;
      }
      .btn-edit {
        background: #f59e0b;
      }
      .btn-delete {
        background: var(--danger);
      }

      .user-badge {
        font-size: 10px;
        background: #e0e7ff;
        color: var(--primary);
        padding: 2px 6px;
        border-radius: 10px;
        margin-left: 5px;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div id="login-page">
      <div class="login-box">
        <h2>Dompet Bersama</h2>
        <p>Masukkan PIN</p>
        <form id="login-form">
          <input type="password" id="login-pin" placeholder="PIN" pattern="[0-9]*" inputmode="numeric" required />
          <button type="submit" class="btn">Masuk</button>
        </form>
      </div>
    </div>

    <div id="app-page">
      <div id="loading">Sinkronisasi Data...</div>

      <div class="header-info">
        <span id="welcome-msg">Halo, User</span>
        <a href="#" onclick="logout()" style="color: var(--danger); text-decoration: none; font-weight: bold">Logout</a>
      </div>

      <div class="balance-card">
        <h2>Sisa Saldo</h2>
        <h1 id="balance">Rp 0</h1>
      </div>

      <div class="summary-grid">
        <div class="card">
          <h4>Pemasukan</h4>
          <p id="money-plus" class="money-plus">+Rp 0</p>
        </div>
        <div class="card">
          <h4>Pengeluaran</h4>
          <p id="money-minus" class="money-minus">-Rp 0</p>
        </div>
      </div>

      <div class="chart-section">
        <h3 style="text-align: center; margin-top: 0">Analisa Pengeluaran</h3>
        <div class="chart-wrapper">
          <canvas id="expenseChart"></canvas>
        </div>
      </div>

      <div class="input-group" id="input-card">
        <h3 id="form-title">Tambah Transaksi</h3>
        <form id="form">
          <input type="hidden" id="edit-id" />

          <div class="form-row">
            <input type="date" id="date" class="form-control" required />
            <select id="type" class="form-control">
              <option value="expense">Pengeluaran (-)</option>
              <option value="income">Pemasukan (+)</option>
            </select>
          </div>

          <input type="text" id="text" class="form-control" placeholder="Keterangan" required />
          <input list="categories" id="category" class="form-control" placeholder="Kategori" required />
          <datalist id="categories">
            <option value="Gaji"></option>
            <option value="Bonus"></option>
            <option value="Belanja Bulanan"></option>
            <option value="Jajan"></option>
            <option value="Listrik/Air"></option>
          </datalist>

          <input type="number" id="amount" class="form-control" placeholder="Jumlah (Rp)" required />

          <button type="submit" id="submit-btn" class="btn">Simpan</button>
          <button type="button" id="cancel-btn" class="btn btn-cancel" onclick="cancelEdit()">Batal Edit</button>
        </form>
      </div>

      <h3>Riwayat</h3>
      <ul id="list" class="history-list"></ul>
    </div>

    <script>
      // --- GANTI URL INI ---
      const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwkEam74ZMFuskgfq9nzEkn3imJfPRQpV38SleairvjbKO_W28iVkJ8tS8G8fdwQ2Ze7Q/exec";

      // --- DATABASE USER ---
      const USER_DB = {
        1234: "Suami",
        5678: "Istri",
      };
      // ----------------------

      let chartInstance = null; // Variabel untuk menyimpan chart

      // Cek Login
      function checkLogin() {
        const currentUser = localStorage.getItem("currentUser");
        if (currentUser) {
          document.getElementById("login-page").style.display = "none";
          document.getElementById("app-page").style.display = "block";
          document.getElementById("welcome-msg").innerText = "Halo, " + currentUser;
          fetchData();
        }
      }

      document.getElementById("login-form").addEventListener("submit", function (e) {
        e.preventDefault();
        const inputPin = document.getElementById("login-pin").value;
        if (USER_DB[inputPin]) {
          localStorage.setItem("currentUser", USER_DB[inputPin]);
          checkLogin();
        } else {
          alert("PIN Salah!");
          document.getElementById("login-pin").value = "";
        }
      });

      function logout() {
        localStorage.removeItem("currentUser");
        location.reload();
      }

      // Logic Aplikasi
      const form = document.getElementById("form");
      const loading = document.getElementById("loading");
      let isEditing = false;

      document.getElementById("date").valueAsDate = new Date();
      window.onload = checkLogin;

      form.addEventListener("submit", function (e) {
        e.preventDefault();
        const type = document.getElementById("type").value;
        const amountVal = document.getElementById("amount").value;
        const editId = document.getElementById("edit-id").value;
        const currentUser = localStorage.getItem("currentUser");

        const data = {
          action: isEditing ? "edit" : "add",
          id: isEditing ? editId : new Date().getTime(),
          date: document.getElementById("date").value,
          type: type,
          text: document.getElementById("text").value,
          category: document.getElementById("category").value,
          amount: type === "expense" ? -Math.abs(amountVal) : Math.abs(amountVal),
          user: currentUser,
        };
        sendData(data);
      });

      function sendData(data) {
        loading.style.display = "block";
        fetch(SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify(data),
        })
          .then((response) => response.json())
          .then((response) => {
            loading.style.display = "none";
            if (response.result === "success") {
              alert("Berhasil!");
              if (isEditing) cancelEdit();
              else form.reset();
              document.getElementById("date").valueAsDate = new Date();
              fetchData();
            } else {
              alert("Gagal: " + response.message);
            }
          })
          .catch((err) => {
            alert("Gagal koneksi internet.");
            loading.style.display = "none";
          });
      }

      function fetchData() {
        loading.style.display = "block";
        fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "get" }) })
          .then((res) => res.json())
          .then((res) => {
            loading.style.display = "none";
            if (res.result === "success") {
              updateDOM(res.data);
              updateChart(res.data); // UPDATE CHART SAAT DATA MASUK
            }
          });
      }

      // --- FUNGSI CHART BARU ---
      function updateChart(transactions) {
        const ctx = document.getElementById("expenseChart").getContext("2d");

        // 1. Kelompokkan pengeluaran berdasarkan kategori
        const categoryTotals = {};
        transactions.forEach((t) => {
          if (t.amount < 0) {
            // Hanya ambil pengeluaran
            const cat = t.category;
            const amt = Math.abs(t.amount);
            if (categoryTotals[cat]) {
              categoryTotals[cat] += amt;
            } else {
              categoryTotals[cat] = amt;
            }
          }
        });

        const labels = Object.keys(categoryTotals);
        const data = Object.values(categoryTotals);

        // Hapus chart lama jika ada (biar gak numpuk)
        if (chartInstance) {
          chartInstance.destroy();
        }

        // Kalau belum ada pengeluaran
        if (labels.length === 0) return;

        // Render Chart Baru
        chartInstance = new Chart(ctx, {
          type: "doughnut", // Tipe Chart: doughnut, pie, atau bar
          data: {
            labels: labels,
            datasets: [
              {
                label: "Pengeluaran",
                data: data,
                backgroundColor: ["#ef4444", "#f59e0b", "#3b82f6", "#10b981", "#8b5cf6", "#ec4899", "#6366f1"],
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom",
                labels: { boxWidth: 12, font: { size: 10 } },
              },
            },
          },
        });
      }
      // -------------------------

      window.startEdit = function (id, date, text, category, amount) {
        isEditing = true;
        document.getElementById("input-card").scrollIntoView({ behavior: "smooth" });
        document.getElementById("input-card").classList.add("editing");
        document.getElementById("form-title").innerText = "Edit Transaksi";
        document.getElementById("submit-btn").innerText = "Update Data";
        document.getElementById("cancel-btn").style.display = "block";

        document.getElementById("edit-id").value = id;
        document.getElementById("date").value = date.split("T")[0];
        document.getElementById("text").value = text;
        document.getElementById("category").value = category;
        document.getElementById("amount").value = Math.abs(amount);
        document.getElementById("type").value = amount < 0 ? "expense" : "income";
      };

      window.cancelEdit = function () {
        isEditing = false;
        form.reset();
        document.getElementById("date").valueAsDate = new Date();
        document.getElementById("input-card").classList.remove("editing");
        document.getElementById("form-title").innerText = "Tambah Transaksi";
        document.getElementById("submit-btn").innerText = "Simpan";
        document.getElementById("cancel-btn").style.display = "none";
      };

      window.deleteItem = function (id) {
        if (confirm("Hapus data ini?")) {
          sendData({ action: "delete", id: id });
        }
      };

      function updateDOM(transactions) {
        const list = document.getElementById("list");
        const balance = document.getElementById("balance");
        const money_plus = document.getElementById("money-plus");
        const money_minus = document.getElementById("money-minus");

        list.innerHTML = "";
        if (!transactions) return;

        const amounts = transactions.map((t) => Number(t.amount));
        const total = amounts.reduce((acc, item) => (acc += item), 0);
        const income = amounts.filter((item) => item > 0).reduce((acc, item) => (acc += item), 0);
        const expense = amounts.filter((item) => item < 0).reduce((acc, item) => (acc += item), 0) * -1;

        balance.innerText = formatRupiah(total);
        money_plus.innerText = `+${formatRupiah(income)}`;
        money_minus.innerText = `-${formatRupiah(expense)}`;

        transactions
          .slice()
          .reverse()
          .forEach((t) => {
            const sign = t.amount < 0 ? "-" : "+";
            const item = document.createElement("li");
            item.classList.add("history-item");
            item.classList.add(t.amount < 0 ? "minus" : "plus");

            const safeText = t.text.replace(/'/g, "\\'");
            const safeCat = t.category.replace(/'/g, "\\'");
            const userBadge = t.user ? `<span class="user-badge">${t.user}</span>` : "";

            item.innerHTML = `
                <div style="flex-grow:1">
                    <div style="display:flex; align-items:center">
                        <strong>${t.text}</strong> ${userBadge}
                    </div>
                    <span class="item-cat">${t.category}</span>
                    <small style="color:#888">${t.date.split("T")[0]}</small>
                </div>
                <div style="text-align:right">
                    <span>${sign}${formatRupiah(Math.abs(t.amount))}</span>
                    <div class="item-actions">
                        <button class="btn-mini btn-edit" onclick="startEdit('${t.id}', '${t.date}', '${safeText}', '${safeCat}', ${t.amount})">Edit</button>
                        <button class="btn-mini btn-delete" onclick="deleteItem('${t.id}')">Hapus</button>
                    </div>
                </div>
            `;
            list.appendChild(item);
          });
      }

      function formatRupiah(number) {
        return new Intl.NumberFormat("id-ID", { style: "currency", currency: "IDR", minimumFractionDigits: 0 }).format(number);
      }
    </script>
  </body>
</html>
