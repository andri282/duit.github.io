<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DompetKu - Cloud Sync</title>
    <style>
      :root {
        --primary: #2563eb;
        --success: #16a34a;
        --danger: #dc2626;
        --bg: #f3f4f6;
        --card: #ffffff;
      }
      body {
        font-family: sans-serif;
        background: var(--bg);
        margin: 0;
        padding: 20px;
        color: #333;
      }
      .container {
        max-width: 600px;
        margin: 0 auto;
      }

      /* Loading Overlay */
      #loading {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        z-index: 99;
        text-align: center;
        padding-top: 200px;
        font-weight: bold;
      }

      /* Kartu Saldo */
      .balance-card {
        background: var(--primary);
        color: white;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        margin-bottom: 20px;
      }
      .balance-card h1 {
        margin: 10px 0;
        font-size: 32px;
      }

      .summary-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 20px;
      }
      .card {
        background: var(--card);
        padding: 15px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }
      .money-plus {
        color: var(--success);
        font-weight: bold;
      }
      .money-minus {
        color: var(--danger);
        font-weight: bold;
      }

      /* Form Input */
      .input-group {
        background: var(--card);
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }
      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .form-control {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        box-sizing: border-box;
      }

      /* PIN Input */
      .pin-input {
        border: 2px solid var(--primary);
        background: #eef2ff;
        font-weight: bold;
        letter-spacing: 2px;
        text-align: center;
      }

      .btn {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        background: var(--primary);
        color: white;
      }
      .btn:hover {
        background: #1d4ed8;
      }

      /* List Transaksi */
      .history-list {
        list-style: none;
        padding: 0;
      }
      .history-item {
        background: var(--card);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-left: 5px solid transparent;
      }
      .history-item.plus {
        border-left-color: var(--success);
      }
      .history-item.minus {
        border-left-color: var(--danger);
      }
      .item-details small {
        display: block;
        color: #888;
        margin-top: 4px;
      }
      .item-cat {
        background: #eee;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 11px;
        margin-left: 5px;
      }
    </style>
  </head>
  <body>
    <div id="loading">Sedang Sinkronisasi ke Google Sheet...</div>

    <div class="container">
      <div class="balance-card">
        <h2>Sisa Saldo</h2>
        <h1 id="balance">Rp 0</h1>
        <small style="opacity: 0.8">Data tersimpan di Google Sheet</small>
      </div>

      <div class="summary-grid">
        <div class="card">
          <h4>Pemasukan</h4>
          <p id="money-plus" class="money-plus">+Rp 0</p>
        </div>
        <div class="card">
          <h4>Pengeluaran</h4>
          <p id="money-minus" class="money-minus">-Rp 0</p>
        </div>
      </div>

      <div class="input-group">
        <h3>Tambah Transaksi Baru</h3>
        <form id="form">
          <input type="password" id="pin" class="form-control pin-input" placeholder="Masukkan PIN Rahasia" required />

          <div class="form-row">
            <input type="date" id="date" class="form-control" required />
            <select id="type" class="form-control">
              <option value="expense">Pengeluaran (-)</option>
              <option value="income">Pemasukan (+)</option>
            </select>
          </div>

          <input type="text" id="text" class="form-control" placeholder="Nama Transaksi (cth: Nasi Padang)" required />

          <input list="categories" id="category" class="form-control" placeholder="Kategori" required />
          <datalist id="categories">
            <option value="Gaji"></option>
            <option value="Bonus"></option>
            <option value="Side Hustle"></option>
            <option value="Makan"></option>
            <option value="Transport"></option>
            <option value="Utilities"></option>
            <option value="Kopi"></option>
            <option value="Belanja"></option>
            <option value="Hobi"></option>
          </datalist>

          <input type="number" id="amount" class="form-control" placeholder="Jumlah (Rp)" required />

          <button class="btn">Simpan ke Cloud</button>
        </form>
      </div>

      <h3>Riwayat Terakhir</h3>
      <ul id="list" class="history-list"></ul>
    </div>

    <script>
      // --- GANTI URL INI DENGAN URL DEPLOYMENT GOOGLE SCRIPT KAMU ---
      const SCRIPT_URL = "https://script.google.com/a/macros/student.uns.ac.id/s/AKfycbwkEam74ZMFuskgfq9nzEkn3imJfPRQpV38SleairvjbKO_W28iVkJ8tS8G8fdwQ2Ze7Q/exec";
      // -------------------------------------------------------------

      const form = document.getElementById("form");
      const loading = document.getElementById("loading");

      // Set default date ke hari ini
      document.getElementById("date").valueAsDate = new Date();

      // Simpan PIN di browser biar ga ngetik ulang terus (Opsional)
      const savedPin = localStorage.getItem("user_pin");
      if (savedPin) document.getElementById("pin").value = savedPin;

      // Load Data saat aplikasi dibuka
      window.onload = function () {
        if (savedPin) fetchData(savedPin);
      };

      form.addEventListener("submit", function (e) {
        e.preventDefault();
        const pin = document.getElementById("pin").value;
        localStorage.setItem("user_pin", pin); // Ingat PIN di browser

        const type = document.getElementById("type").value;
        const amountVal = document.getElementById("amount").value;

        // Data yang akan dikirim
        const data = {
          action: "add",
          pin: pin,
          id: new Date().getTime(),
          date: document.getElementById("date").value,
          type: type,
          text: document.getElementById("text").value,
          category: document.getElementById("category").value,
          // Jika expense, jadikan negatif
          amount: type === "expense" ? -Math.abs(amountVal) : Math.abs(amountVal),
        };

        sendData(data);
      });

      function sendData(data) {
        loading.style.display = "block";

        fetch(SCRIPT_URL, {
          method: "POST",
          mode: "no-cors", // Penting untuk Google Script
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        })
          .then(() => {
            // Karena mode 'no-cors', kita tidak bisa baca respons JSON detail
            // Jadi kita asumsikan berhasil, lalu refresh data
            alert("Data terkirim! Sedang mengambil data terbaru...");
            form.reset();
            document.getElementById("date").valueAsDate = new Date();
            document.getElementById("pin").value = localStorage.getItem("user_pin");
            fetchData(data.pin); // Refresh tampilan
          })
          .catch((err) => {
            alert("Error koneksi");
            loading.style.display = "none";
          });
      }

      function fetchData(pin) {
        loading.style.display = "block";

        // Trik fetch POST dengan action="get" agar body bisa bawa PIN
        fetch(SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify({ action: "get", pin: pin }),
        })
          .then((response) => response.json())
          .then((response) => {
            loading.style.display = "none";
            if (response.result === "error") {
              alert(response.message); // Misal PIN salah
              return;
            }
            updateDOM(response.data);
          });
      }

      function updateDOM(transactions) {
        const list = document.getElementById("list");
        const balance = document.getElementById("balance");
        const money_plus = document.getElementById("money-plus");
        const money_minus = document.getElementById("money-minus");

        list.innerHTML = "";

        // Hitung Saldo
        const amounts = transactions.map((t) => Number(t.amount));
        const total = amounts.reduce((acc, item) => (acc += item), 0);
        const income = amounts.filter((item) => item > 0).reduce((acc, item) => (acc += item), 0);
        const expense = amounts.filter((item) => item < 0).reduce((acc, item) => (acc += item), 0) * -1;

        balance.innerText = formatRupiah(total);
        money_plus.innerText = `+${formatRupiah(income)}`;
        money_minus.innerText = `-${formatRupiah(expense)}`;

        // Tampilkan List (Balik urutan biar yang baru di atas)
        transactions
          .slice()
          .reverse()
          .forEach((t) => {
            const sign = t.amount < 0 ? "-" : "+";
            const item = document.createElement("li");
            item.classList.add("history-item");
            item.classList.add(t.amount < 0 ? "minus" : "plus");

            item.innerHTML = `
                <div class="item-details">
                    <strong>${t.text}</strong> <span class="item-cat">${t.category}</span>
                    <small>${t.date}</small>
                </div>
                <span>${sign}${formatRupiah(Math.abs(t.amount))}</span>
            `;
            list.appendChild(item);
          });
      }

      function formatRupiah(number) {
        return new Intl.NumberFormat("id-ID", { style: "currency", currency: "IDR", minimumFractionDigits: 0 }).format(number);
      }
    </script>
  </body>
</html>
